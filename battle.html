<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pokemon Battle</title>
    <style>
      .info-container {
        display: flex;
        align-items: baseline;
        gap: 50px;
      }
      .pokemon-all-container {
        display: flex;
        align-items: baseline;
        gap: 400px;
      }
    </style>
  </head>
  <body>
    <div class="info-container">
      <div class="txt-container">
        <p>Squirtle</p>
        <p id="squirtle-hp-txt">HP</p>
        <p id="squirtle-level-txt">Level</p>
        <p id="squirtle-money-txt">Penger</p>
      </div>
      <div class="txt-container">
        <p>Vulpix</p>
        <p id="vulpix-hp-txt">HP</p>
        <p id="vulpix-level-txt">Level</p>
        <p id="vulpix-money-txt">Penger</p>
      </div>

      <div class="txt-container">
        <p>Pikachu</p>
        <p id="pikachu-hp-txt">HP</p>
        <p id="pikachu-level-txt">Level</p>
        <p id="pikachu-money-txt">Penger</p>
      </div>

      <img
        src="/assets/pokemonBall.jpg"
        id="squirtle"
        alt="pokemonBall"
        width="120px"
        height=""
      />
      <img
        src="/assets/pokemonBall.jpg"
        id="vulpix"
        alt="pokemonBall"
        width="120px"
        height=""
      />
      <input type="button" value="Pikachu" id="attack-btn" />
    </div>
    <div class="pokemon-all-container">
      <div class="pokemon-container"></div>
      <div class="bad-guy-container"></div>
    </div>
    <script>
      let squirtleHpTxt = document.querySelector("#squirtle-hp-txt");
      let vulpixHpTxt = document.querySelector("#vulpix-hp-txt");
      let pikachuHpTxt = document.querySelector("#pikachu-hp-txt");

      let squirtleLevelTxt = document.querySelector("#squirtle-level-txt");
      let vulpixLevelTxt = document.querySelector("#vulpix-level-txt");
      let pikachuLevelTxt = document.querySelector("#pikachu-level-txt");

      let squirtleMoneyTxt = document.querySelector("#squirtle-money-txt");
      let vulpixMoneyTxt = document.querySelector("#vulpix-money-txt");
      let pikachuMoneyTxt = document.querySelector("#pikachu-money-txt");

      const squirtle = document.querySelector("#squirtle");
      const vulpix = document.querySelector("#vulpix");
      const pokemonContainer = document.querySelector(".pokemon-container");
      const badGuyContainer = document.querySelector(".bad-guy-container");
      const pokemonAllContainer = document.querySelector(
        ".pokemon-all-container"
      );
      let pokemonGood = JSON.parse(localStorage.getItem("pokemonGood")) || [];
      let pokemonBad = JSON.parse(localStorage.getItem("pokemonBad")) || [];

      async function fetchBattlePokemon(name) {
        const pokemonRequest = await fetch(
          `https://pokeapi.co/api/v2/pokemon/${name}/`
        );
        let response = await pokemonRequest.json();
        return response;
      }
      // fetchAndShowBadPokemon("pikachu");
      getPikaTest();
      function getPokemon(name) {
        if (name === "raichu") {
          pokemonBad.splice(0, 1);
          //pokemonBad.push("raichu")
          localStorage.setItem("pokemonBad", JSON.stringify(pokemonBad));
          fetchAndShowBadPokemon("raichu");
        } else if (name === "pikachu") {
          fetchAndShowBadPokemon("pikachu");
        }
      }

      async function fetchAndShowBadPokemon(name) {
        try {
          const savedPikachu = pokemonBad.find(
            (pokemon) => pokemon.name === name
          );
          if (!savedPikachu) {
            let idOfPokemon = await fetchBattlePokemon(name);
            pokemonBad.push({
              name: idOfPokemon.name,
              image:
                idOfPokemon.sprites.other["official-artwork"].front_default,
              type: idOfPokemon.types[0].type.name,
              originalHp: idOfPokemon.stats[0].base_stat,
              hp: idOfPokemon.stats[0].base_stat,
              attack: idOfPokemon.stats[1].base_stat,
              defense: idOfPokemon.stats[2].base_stat,
              specialAttack: idOfPokemon.stats[3].base_stat,
              specialDefense: idOfPokemon.stats[4].base_stat,
              speed: idOfPokemon.stats[5].base_stat,
              level: 0,
              money: 0,
            });
          }
          localStorage.setItem("pokemonBad", JSON.stringify(pokemonBad));
          showBadPokemon(pokemonBad);
        } catch (error) {
          console.error("Her klarte vi ikke å lase inn pokemons", error);
        }
      }

      async function fetchAndShowPokemon(name) {
        try {
          let idOfPokemon = await fetchBattlePokemon(name);
          let pokemon = {
            name: idOfPokemon.name,
            image: idOfPokemon.sprites.other["official-artwork"].front_default,
            type: idOfPokemon.types[0].type.name,
            originalHp: idOfPokemon.stats[0].base_stat,
            hp: idOfPokemon.stats[0].base_stat,
            attack: idOfPokemon.stats[1].base_stat,
            defense: idOfPokemon.stats[2].base_stat,
            specialAttack: idOfPokemon.stats[3].base_stat,
            specialDefense: idOfPokemon.stats[4].base_stat,
            speed: idOfPokemon.stats[5].base_stat,
            level: 0,
            money: 0,
          };
          pokemonGood.push(pokemon);
          localStorage.setItem("pokemonGood", JSON.stringify(pokemonGood));
          showGoodPokemon(pokemonGood);
        } catch (error) {
          console.error("Her klarte vi ikke å lase inn pokemons", error);
        }
      }

      function showGoodPokemon(pokemons) {
        console.log("vis pokemon:", pokemons);
        pokemonContainer.innerHTML = "";
        pokemons.forEach((pokemon, index) => {
          updateInnerHtml(pokemon);
          const pickMeBtn = document.createElement("button");
          pickMeBtn.innerHTML = "Velg meg";
          pickMeBtn.style.backgroundColor = "white";
          pickMeBtn.addEventListener("click", function () {
            pickMeBtn.remove();
            startGame(pokemon);
          });

          const pokemonCard = document.createElement("div");
          pokemonContainer.style.display = "flex";
          pokemonContainer.style.flexWrap = "wrap";
          pokemonContainer.style.gap = "10px";

          pokemonCard.style.background =
            pokemon.type == "water"
              ? "#1451E3"
              : pokemon.type == "fire"
              ? "#AA1E21"
              : (pokemonCard.style.width = "200px");
          pokemonCard.style.height = "460px";
          pokemonCard.style.padding = "10px";
          pokemonCard.innerHTML = `<img src="${pokemon.image}" style="width: 200px" />
      <h3>Navn: ${pokemon.name} <br>Type: ${pokemon.type}</h3> <h4>STATS<br>HP: ${pokemon.hp}<br>Attack: ${pokemon.attack}<br>Defense: ${pokemon.defense}<br>Special attack: ${pokemon.specialAttack}<br> Special defense: ${pokemon.specialDefense}<br> Speed: ${pokemon.speed}</h4>`;
          pokemonCard.append(pickMeBtn);
          pokemonContainer.appendChild(pokemonCard);
        });
      }
      function showBadPokemon(pokemons) {
        badGuyContainer.innerHTML = "";
        console.log("vis pika", pokemons);
        pokemons.forEach((pokemon, index) => {
          const pokemonBadCard = document.createElement("div");
          // pokemonBadCard.style.marginLeft = "auto";
          badGuyContainer.style.display = "flex";
          badGuyContainer.style.flexWrap = "wrap";
          badGuyContainer.style.gap = "10px";
          // pokemonBadCard.style.position = "fixed";
          pokemonBadCard.style.background =
            pokemon.type == "electric"
              ? "#E2E22A"
              : (pokemonBadCard.style.width = "200px");
          pokemonBadCard.style.height = "460px";
          pokemonBadCard.style.padding = "10px";
          pokemonBadCard.innerHTML = `<img src="${pokemon.image}" style="width: 200px" />
      <h3>Navn: ${pokemon.name} <br>Type: ${pokemon.type}</h3> <h4>STATS<br>HP: ${pokemon.hp}<br>Attack: ${pokemon.attack}<br>Defense: ${pokemon.defense}<br>Special attack: ${pokemon.specialAttack}<br> Special defense: ${pokemon.specialDefense}<br> Speed: ${pokemon.speed}</h4>`;

          badGuyContainer.appendChild(pokemonBadCard);
        });
      }

      squirtle.addEventListener("click", () => {
        squirtle.src = "/assets/open.jpg";
        let savedWartortle = pokemonGood.find(
          (pokemon) => pokemon.name === "wartortle"
        );
        if (savedWartortle) {
          showGoodPokemon([savedWartortle]);
        } else {
          let savedSquirtle = pokemonGood.find(
            (pokemon) => pokemon.name === "squirtle"
          );
          if (savedSquirtle) {
            showGoodPokemon([savedSquirtle]);
          } else {
            fetchAndShowPokemon("squirtle");
          }
        }
      });
      vulpix.addEventListener("click", () => {
        vulpix.src = "/assets/open.jpg";

        let savedNinetales = pokemonGood.find(
          (pokemon) => pokemon.name === "ninetales"
        );
        if (savedNinetales) {
          showGoodPokemon([savedNinetales]);
        } else {
          let savedVulpix = pokemonGood.find(
            (pokemon) => pokemon.name === "vulpix"
          );
          if (savedVulpix) {
            showGoodPokemon([savedVulpix]);
          } else {
            fetchAndShowPokemon("vulpix");
          }
        }
      });

      function getPikaTest() {
        const attackBtn = document.querySelector("#attack-btn");
        attackBtn.addEventListener("click", function () {
          getPokemon("pikachu");
          attackBtn.remove();
        });
      }
      function startAttack(pokemon) {
        document.addEventListener("keydown", function (event) {
          if (event.key == "a") {
            console.log("jeg ble trykket på", pokemon);
            attack(pokemon);
          }
        });
      }
      function startGame(pokemon) {
        /// en knapp, kanskje?
        console.log("start game", pokemon);
        startAttack(pokemon);
      }

      function attack(pokemon) {
        if (pokemonBad[0].hp > 0) {
          let { amountOfDamageGoodRound } = calculateDamageFromAttack(
            pokemon,
            pokemonBad[0]
          ); // setning tatt fra chat
          pokemonBad[0].hp -= amountOfDamageGoodRound;
          alert(
            `${pokemon.name} har skadet ${pokemonBad[0].name} med ${amountOfDamageGoodRound} poeng`
          );
          updateInnerHtml(pokemon);
          updateInnerHtml(pokemonBad[0]);
          badGuyAttack(pokemon);
          winnerPokemon(pokemon);
        }
      }

      function calculateDamageFromAttack(pokemon) {
        let amoundOfDamageGood = (15 * pokemon.attack) / pokemonBad[0].defense;
        let amoundOfDamageBad = (2 * pokemonBad[0].attack) / pokemon.defense;

        let amountOfDamageGoodRound = Math.round(amoundOfDamageGood);
        let amountOfDamageBadRound = Math.round(amoundOfDamageBad);

        return { amountOfDamageGoodRound, amountOfDamageBadRound };
      }
      function updateInnerHtml(pokemon) {
        if (pokemon.name === "squirtle") {
          squirtleHpTxt.innerHTML = `${pokemon.hp} / 44 HP`;
          squirtleLevelTxt.innerHTML = `${pokemon.level} / 36 Level`;
          squirtleMoneyTxt.innerHTML = `${pokemon.money} / 0 Penger`;
        } else if (pokemon.name === "vulpix") {
          vulpixHpTxt.innerHTML = `${pokemon.hp} / 38 HP`;
          vulpixLevelTxt.innerHTML = `${pokemon.level} / 20 Level`;
          vulpixMoneyTxt.innerHTML = `${pokemon.money} / 0 Penger`;
        }
        if (pokemonBad.length > 0 && pokemonBad[0].name === "pikachu") {
          pikachuHpTxt.innerHTML = `${pokemonBad[0].hp} / 35 HP`;
          pikachuLevelTxt.innerHTML = `${pokemonBad[0].level} / 20 Level`;
          pikachuMoneyTxt.innerHTML = `${pokemonBad[0].money} / 0 Penger`;
        }
      }

      function badGuyAttack(pokemon) {
        if (pokemon.hp > 0 && pokemonBad[0].hp > 0) {
          let { amountOfDamageBadRound } = calculateDamageFromAttack(
            pokemon,
            pokemonBad
          );
          pokemon.hp -= amountOfDamageBadRound;
          alert(
            `${pokemonBad[0].name} har skadet ${pokemon.name} med ${amountOfDamageBadRound} poeng`
          );
          console.log(pokemon);
          console.log(pokemonBad);
          updateInnerHtml(pokemon);
          updateInnerHtml(pokemonBad[0]);
          winnerPokemon(pokemon);
        }
      }

      function evolvePokemon(pokemon) {
        if (pokemonBad[0].name === "pikachu" && pokemonBad[0].level === 5) {
          updateInnerHtml(pokemon);
          pokemonBad[0].level -= 5;

          alert(
            "Du har funnet thunder stone, men er utenfor Alola, og evolves til raichu"
          );

          getPokemon("raichu");
          localStorage.setItem("pokemonBad", JSON.stringify(pokemonBad));
          console.log("hva er her", pokemonBad);
          saveToLocal(pokemonBad[0]);
        }
        if (pokemon.name === "squirtle" && pokemon.level === 15) {
          updateInnerHtml(pokemon);
          pokemon.level -= 15;
          //else if med penger??
          //alert med pokemon.name?
          const index = pokemonGood.findIndex(
            (pokemon) => pokemon.name === "squirtle"
          );
          if (index !== -1) {
            pokemonGood.splice(index, 1);
            localStorage.setItem("pokemonGood", JSON.stringify(pokemonGood));
            alert("Du har oppnådd en ny pokemon med navn wartortle");
            fetchAndShowPokemon("wartortle");

            console.log("evolve", pokemon);
            console.log("evolve", pokemonGood);
          }
          //pokemonGood.splice(0, 1);
          //localStorage.setItem("pokemonGood", JSON.stringify(pokemonGood));
        } else if (pokemon.name === "wartortle" && pokemon.level === 20) {
          pokemon.level -= 20;

          const index = pokemonGood.findIndex(
            (pokemon) => pokemon.name === "wartortle"
          );
          if (index !== -1) {
            pokemonGood.splice(index, 1);
            localStorage.setItem("pokemonGood", JSON.stringify(pokemonGood));
            alert("Du har oppnådd en ny pokemon med navn blastoise");
            fetchAndShowPokemon("blastoise");
          }
        }
        if (pokemon.name === "vulpix" && pokemon.money === 300) {
          updateInnerHtml(pokemon);
          pokemon.money -= 300;
          const findVulpix = pokemonGood.find(
            (pokemon) => pokemon.name === "vulpix"
          );
          if (findVulpix) {
            pokemonGood.splice([findVulpix], 1);
            localStorage.setItem("pokemonGood", JSON.stringify(pokemonGood));
            alert("Du har funnet fire stone og har nå tilgan til ninetales");
            fetchAndShowPokemon("ninetales");
          }
          //pokemonGood.splice(0, 1);
        }
      }
      function winnerPokemon(pokemon) {
        updateInnerHtml(pokemon);
        updateInnerHtml(pokemonBad[0]);
        if (pokemon.hp <= 0 && pokemonBad[0].hp > 0) {
          alert(
            `De gode tapte denne gangen, og den onde ${pokemonBad[0].name} vant! Bedre lykke neste gang:)`
          );
          pokemonBad[0].level += 5;
          saveToLocal(pokemon);
          saveToLocal(pokemonBad);
          //må legge til litt her
        } else if (pokemonBad[0].hp <= 0 && pokemon.hp > 0) {
          alert(`Bra jobba! Den gode ${pokemon.name} vant`);
          saveToLocal(pokemon);
          saveToLocal(pokemonBad);
          let userAnswer = prompt(
            "100 kr eller 5 ekstra level? Det bestemmer du! skriv penger eller level"
          ).toLowerCase(); //kan jeg sette den der?
          if (userAnswer === "penger") {
            pokemon.money += 100;
            alert(`${pokemon.name} har valgt penger!`);
          } else if (userAnswer === "level") {
            pokemon.level += 5;
            alert(`${pokemon.name} har valgt level!`);
          } else {
            alert("siste sjanse!");
            let userAnswer = prompt(
              "100 kr eller 5 ekstra level? Det bestemmer du! skriv penger eller level"
            ).toLowerCase(); //kan jeg sette den der?
            if (userAnswer !== "penger" && userAnswer !== "level") {
              pokemon.level += 1;
              alert(
                `${pokemon.name} får kun 1 ekstra level, fordi du ikke ville skrive/velge`
              );
            }
          }

          alert("Du kan fortsette neste kamp, ved å trykke på a");

          //updateInnerHtml(pokemon); // sjekker igjen om det funker
          // window.location.reload();
          saveToLocal(pokemon);
        }
        evolvePokemon(pokemon);
        //showGoodPokemon(pokemon);
      }

      function saveToLocal(pokemon) {
        pokemon.hp = pokemon.originalHp;
        if (pokemonBad[0].name === "pikachu") {
          pokemonBad[0].hp = pokemonBad[0].originalHp;
        } else if (pokemonBad[0].name === "raichu") {
          pokemonBad[0].hp = pokemonBad[0].originalHp;
        }
        localStorage.setItem("pokemonGood", JSON.stringify(pokemonGood));
        localStorage.setItem("pokemonBad", JSON.stringify(pokemonBad));
        updateInnerHtml(pokemon);
        updateInnerHtml(pokemonBad[0]);
        //const myTimeout = setTimeout(reload, 5000);
      }
    </script>
  </body>
</html>
